---
import Layout from '../../../layouts/Layout.astro';
import { blogPosts } from '../../../i18n/blog';
import { getBlogPostContent } from '../../../i18n/blog';
import BlogHeader from '../../../components/blog-post/BlogHeader.astro';
import FeaturedImage from '../../../components/blog-post/FeaturedImage.astro';
import BlogContent from '../../../components/blog-post/BlogContent.astro';
import TableOfContentsInline from '../../../components/blog-post/TableOfContentsInline.astro';
import ShareButtons from '../../../components/blog-post/ShareButtons.astro';
import AuthorBoxSidebar from '../../../components/blog-post/AuthorBoxSidebar.astro';
import RelatedPosts from '../../../components/blog-post/RelatedPosts.astro';
import BlogCTA from '../../../components/blog-post/BlogCTA.astro';

export const prerender = true;

export async function getStaticPaths() {
  return [
    { params: { lang: 'en', id: 'responsive-web-design-bootstrap' } },
    { params: { lang: 'en', id: 'customer-persona' } },
    { params: { lang: 'en', id: 'mobile-optimization' } },
    { params: { lang: 'en', id: 'seo-vs-ppc' } },
    { params: { lang: 'en', id: 'integrated-digital-marketing' } },
    { params: { lang: 'en', id: 'custom-chatbot' } },
    { params: { lang: 'en', id: 'website-traffic' } },
    { params: { lang: 'en', id: 'ai-digital-marketing' } },
    { params: { lang: 'en', id: 'ai-chatbot-business' } },
    { params: { lang: 'zh', id: 'responsive-web-design-bootstrap' } },
    { params: { lang: 'zh', id: 'customer-persona' } },
    { params: { lang: 'zh', id: 'mobile-optimization' } },
    { params: { lang: 'zh', id: 'seo-vs-ppc' } },
    { params: { lang: 'zh', id: 'integrated-digital-marketing' } },
    { params: { lang: 'zh', id: 'custom-chatbot' } },
    { params: { lang: 'zh', id: 'website-traffic' } },
    { params: { lang: 'zh', id: 'ai-digital-marketing' } },
    { params: { lang: 'zh', id: 'ai-chatbot-business' } },
  ];
}

const { lang, id } = Astro.params;

// Find the blog post metadata
const posts = blogPosts[lang as keyof typeof blogPosts];
const post = posts.find((p) => p.id === id);

// If post not found, show 404
if (!post) {
  return Astro.redirect('/404');
}

// Get full blog content from markdown file
const blogContent = await getBlogPostContent(lang as 'en' | 'zh', id);

// Get related posts (exclude current post)
const relatedPosts = posts
  .filter((p) => p.id !== id)
  .slice(0, 3)
  .map((p) => ({
    id: p.id,
    title: p.title,
    excerpt: p.excerpt,
    image: p.image,
  }));

// Get author info
const authorName = blogContent?.metadata?.author || post.title || 'Sarah Johnson';
const readTime = blogContent?.metadata?.readTime || '5 min read';

const blogUrl = `${Astro.site?.origin || ''}/blog/${post.id}`;

// Extract headings from content for table of contents
const extractHeadings = (html: string) => {
  const headingRegex = /<h([2-6])[^>]*id="([^"]*)"[^>]*>(.*?)<\/h\1>/gi;
  const headings: Array<{ text: string; id: string; level: number }> = [];
  let match;
  while ((match = headingRegex.exec(html)) !== null) {
    headings.push({
      text: match[3].replace(/<[^>]*>/g, ''),
      id: match[2],
      level: parseInt(match[1]),
    });
  }
  return headings;
};

const headings = blogContent?.content ? extractHeadings(blogContent.content) : [];
---

<Layout
  title={`${post.title} - Aivio Digital`}
  lang={lang}
  currentLang={lang as 'en' | 'zh'}
  currentPath={`/blog/${id}`}
>
  <BlogHeader
    title={post.title}
    category={post.category}
    date={post.date}
    readTime={readTime}
  />

  <FeaturedImage
    alt={post.title}
  />

  <section class="article-wrapper">
    <div class="container">
      <div class="article-layout">
        <div class="main-content">
          <BlogContent content={blogContent?.content || `<p>Content not found for this post.</p>`} />
        </div>

        <aside class="sidebar">
          <div class="sidebar-section">
            <h4 class="sidebar-title">Table of Contents</h4>
            <TableOfContentsInline headings={headings} />
          </div>

          <div class="sidebar-section">
            <h4 class="sidebar-title">Share This Article</h4>
            <ShareButtons url={blogUrl} title={post.title} />
          </div>

          <div class="sidebar-section">
            <h4 class="sidebar-title">About the Author</h4>
            <AuthorBoxSidebar
              name={authorName}
              role="Digital Marketing Expert"
              bio="Passionate about helping businesses grow through innovative digital strategies and data-driven decisions."
            />
          </div>
        </aside>
      </div>
    </div>
  </section>

  <RelatedPosts posts={relatedPosts} title="Related Articles" />

  <BlogCTA />
</Layout>

<style>
  .article-wrapper {
    background: #f8f9fa;
    padding: 60px 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .article-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 40px;
    align-items: start;
  }

  .main-content {
    min-width: 0;
  }

  .sidebar {
    position: sticky;
    top: 20px;
  }

  .sidebar-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
  }

  .sidebar-title {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
  }

  @media (max-width: 1024px) {
    .article-layout {
      grid-template-columns: 1fr;
    }

    .sidebar {
      position: static;
    }
  }

  @media (max-width: 640px) {
    .article-wrapper {
      padding: 40px 0;
    }
  }
</style>
